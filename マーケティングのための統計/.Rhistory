x = 1, xend = 2,
y = 3904, yend = 3904,
size = 0.1,
linetype = 2) +
annotate("segment", # for (1)
x = 2.07, xend = 2.07,
y = 2261, yend = 2458,
arrow = arrow(ends = "both",
length = unit(.1,"cm"),angle = 90)) +
annotate("segment", # for (2)
x = 2.07, xend = 2.07,
y = 3904, yend = 3904 + 197,
arrow = arrow(ends = "both",
length = unit(.1,"cm"),angle = 90)) +
annotate("segment", # for (3)
x = 2.07, xend = 2.07,
y = 3904, yend = 2547,
arrow = arrow(ends = "both",
length = unit(.1,"cm"),angle = 90))
did_plot
# 集計と可視化による分析
## 集計による推定
JS_grp_summary <- JS_sum %>%
mutate(year = paste("year", year, sep = "_")) %>%
spread(year, death) %>% # spread 関数で展開する
mutate(gap = year_1854 - year_1849,
gap_rate = year_1854/year_1849 - 1)
JS_grp_summary
## 集計による推定(log)
JS_grp_summary_ln <- JS_sum %>%
mutate(year = paste("year", year, sep = "_"),
death = log(death)) %>%
spread(year, death) %>%
mutate(gap = year_1854 - year_1849)
JS_grp_summary_ln
## ggplotによる可視化
did_plot <- JS_sum %>%
ggplot(aes(y = death, x = year, shape = company)) +
geom_point(size = 2) +
geom_line(aes(group = company), linetype = 1) +
ylim(2000, 4250) +
theme_bw() +
theme(plot.title = element_text(hjust = 0.5),
legend.position = "bottom",
plot.margin = margin(1,1,1,1, "cm"))
did_plot
## ggplotによる可視化(アノテーションを追加)
did_plot +
annotate("text", x = 2.2, y = 2400, label = "(1)") +
annotate("text", x = 2.2, y = 3904 + 197*0.6, label = "(2)") +
annotate("text", x = 2.2, y = 3300, label = "(3)") +
annotate("segment", # for common trend in treatment group
x = 1, xend = 2,
y = 3904, yend = 3904 + 197,
arrow = arrow(length = unit(.2,"cm")),
size = 0.1,
linetype = 2) +
annotate("segment", # for parallel trend
x = 1, xend = 2,
y = 2261, yend = 2261,
size = 0.1,
linetype = 2) +
annotate("segment", # for parallel trend
x = 1, xend = 2,
y = 3904, yend = 3904,
size = 0.1,
linetype = 2) +
annotate("segment", # for (1)
x = 2.07, xend = 2.07,
y = 2261, yend = 2458,
arrow = arrow(ends = "both",
length = unit(.1,"cm"),angle = 90)) +
annotate("segment", # for (2)
x = 2.07, xend = 2.07,
y = 3904, yend = 3904 + 197,
arrow = arrow(ends = "both",
length = unit(.1,"cm"),angle = 90)) +
annotate("segment", # for (3)
x = 2.07, xend = 2.07,
y = 3904, yend = 2547,
arrow = arrow(ends = "both",
length = unit(.1,"cm"),angle = 90))
# 回帰分析を用いたDID
## Difference in Difference
JS_did <- JS_sum %>%
mutate(D1854 = if_else(year == 1854, 1, 0)) %>%
lm(data = ., death ~ LSV + D1854 + D1854:LSV) %>%
tidy()
JS_did
JS_did_log <- JS_sum %>%
mutate(D1854 = if_else(year == 1854, 1, 0)) %>%
lm(data = ., log(death) ~ LSV + D1854 + D1854:LSV) %>%
tidy()
JS_did
JS_did_area <- JS_df %>%
mutate(D1854 = if_else(year == 1854, 1, 0)) %>%
lm(data = ., death ~ LSV + area + D1854 + D1854:LSV) %>%
tidy() %>%
filter(!str_detect(term, "area"))
JS_did_area
## Difference in Difference(州単位、log)
JS_did_area_log <- JS_df %>%
mutate(D1854 = if_else(year == 1854, 1, 0)) %>%
lm(data = ., log(death) ~ LSV + area + D1854 + D1854:LSV) %>%
tidy() %>%
#filter(!str_detect(term, "area"))
## Difference in Difference(エリア単位)
JS_did_area <- JS_df %>%
mutate(D1854 = if_else(year == 1854, 1, 0)) %>%
lm(data = ., death ~ LSV + area + D1854 + D1854:LSV) %>%
tidy() %>%
#filter(!str_detect(term, "area"))
## Difference in Difference(州単位、log)
JS_did_area_log <- JS_df %>%
mutate(D1854 = if_else(year == 1854, 1, 0)) %>%
lm(data = ., log(death) ~ LSV + area + D1854 + D1854:LSV) %>%
tidy() %>%
filter(!str_detect(term, "area"))
## Difference in Difference(エリア単位)
JS_did_area <- JS_df %>%
mutate(D1854 = if_else(year == 1854, 1, 0)) %>%
lm(data = ., death ~ LSV + area + D1854 + D1854:LSV) %>%
tidy() #%>%
JS_did_area
## Difference in Difference(エリア単位)
JS_did_area <- JS_df %>%
mutate(D1854 = if_else(year == 1854, 1, 0)) %>%
lm(data = ., death ~ LSV + area + D1854 + D1854:LSV) %>%
tidy() %>%
filter(!str_detect(term, "area"))
JS_did_area
JS_df
JS_did_area_log <- JS_df %>%
mutate(D1854 = if_else(year == 1854, 1, 0)) %>%
lm(data = ., log(death) ~ LSV + area + D1854 + D1854:LSV) %>%
tidy() %>%
filter(!str_detect(term, "area"))
# 回帰分析を用いたDID
## Difference in Difference
JS_did <- JS_sum %>%
mutate(D1854 = if_else(year == 1854, 1, 0)) %>%
lm(data = ., death ~ LSV + D1854 + D1854:LSV) %>%
tidy()
JS_did
## Difference in Difference(log)
JS_did_log <- JS_sum %>%
mutate(D1854 = if_else(year == 1854, 1, 0)) %>%
lm(data = ., log(death) ~ LSV + D1854 + D1854:LSV) %>%
tidy()
JS_did_log
## Difference in Difference(エリア単位)
JS_did_area <- JS_df %>%
mutate(D1854 = if_else(year == 1854, 1, 0)) %>%
lm(data = ., death ~ LSV + area + D1854 + D1854:LSV) %>%
tidy() %>%
filter(!str_detect(term, "area"))
JS_did_area
## Difference in Difference(州単位、log)
JS_did_area_log <- JS_df %>%
mutate(D1854 = if_else(year == 1854, 1, 0)) %>%
lm(data = ., log(death) ~ LSV + area + D1854 + D1854:LSV) %>%
tidy() %>%
filter(!str_detect(term, "area"))
JS_did_area_log
# (5) 分析するデータのあるパッケージをインストール(初回のみ)
install.packages("Ecdat")
# (6) ライブラリの読み込み
library("Ecdat")
# (7) Proposition99の分析：集計による分析
## データの準備
### Common Trend Assumptionの為に分析から特定の州を外す
### タバコの税金が1988年以降50セント以上上がった州のリスト
### Alaska, Hawaii, Maryland, Michigan, New Jersey, New York, Washington
skip_state <- c(3,9,10,22,21,23,31,33,48)
### Cigarデータセットの読み込み
### skip_stateに含まれる州のデータを削除
Cigar <- Cigar %>%
filter(!state %in% skip_state,
year >= 70) %>%
mutate(area = if_else(state == 5, "CA", "Rest of US"))
## 前後比較による分析
Cigar %>%
mutate(period = if_else(year > 87, "after", "before"),
state = if_else(state == 5, "CA", "Rest of US")) %>%
group_by(period, state) %>%
summarise(sales = sum(sales*pop16)/sum(pop16)) %>%
spread(state, sales)
## 前後比較のプロット
Cigar %>%
mutate(period = if_else(year > 87, "after", "before"),
state = if_else(state == 5, "CA", "Rest of US")) %>%
group_by(period, state) %>%
summarise(sales = sum(sales*pop16)/sum(pop16)) %>%
ggplot(aes(y = sales,
x = period,
shape = state,
linetype = state)) +
geom_point(size = 2) +
geom_line(aes(group = state)) +
ylim(0, NA) +
theme_bw() +
theme(plot.title = element_text(hjust = 0.5),
legend.position = "bottom",
plot.margin = margin(1,1,1,1, "cm")) +
scale_x_discrete(name ="Period",limits=c("before","after"))
## タバコの売上のトレンドを示すプロット
Cigar %>%
mutate(state = if_else(state == 5, "CA", "Rest of US")) %>%
group_by(year,state) %>%
summarise(sales = sum(sales*pop16)/sum(pop16)) %>%
ggplot(aes(y = sales,
x = year,
shape = state,
linetype = state)) +
geom_line() +
geom_point(size = 2) +
geom_vline(xintercept = 88, linetype = 4) +
theme_bw() +
theme(plot.title = element_text(hjust = 0.5),
legend.position = "bottom",
plot.margin = margin(1,1,1,1, "cm"))
# (8) DIDのためのデータを準備
## カリフォルニア州とその他という2グループのデータ
Cigar_did_sum <- Cigar %>%
mutate(post = if_else(year > 87, 1, 0),
ca = if_else(state == 5, 1, 0),
state = factor(state),
year_dummy = paste("D", year, sep = "_")) %>%
group_by(post, year, year_dummy, ca) %>%
summarise(sales = sum(sales*pop16)/sum(pop16))
## カリフォルニア州とその他の州という州ごとでのデータ
Cigar_did_data <- Cigar %>%
mutate(post = if_else(year > 87, 1, 0),
ca = if_else(state == 5, 1, 0),
state = factor(state),
year_dummy = paste("D", year, sep = "_")) %>%
group_by(post, ca, year, year_dummy, state) %>%
summarise(sales = sum(sales*pop16)/sum(pop16))
# (9) カリフォルニア州とその他というグループでの分析
## 2グループでのデータでの分析
Cigar_did_sum_reg <- Cigar_did_sum %>%
lm(data = ., sales ~ ca + post + ca:post + year_dummy) %>%
tidy() %>%
filter(!str_detect(term, "state"),
!str_detect(term, "year"))
## 2グループでのデータでの分析(log)
Cigar_did_sum_logreg <- Cigar_did_sum %>%
lm(data = ., log(sales) ~ ca + post + ca:post + year_dummy) %>%
tidy() %>%
filter(!str_detect(term, "state"),
!str_detect(term, "year"))
# (10) 州ごとのデータでの分析
## miceaddsのインストール
install.packages("miceadds")
## 州ごとのデータでの分析
Cigar_did_data_cluster <- Cigar_did_data %>%
miceadds::lm.cluster(data = .,
sales ~ ca + state + post + ca:post + year_dummy,
cluster = "state") %>%
summary()
install.packages("miceadds")
knitr::opts_chunk$set(echo = TRUE)
## 州ごとのデータでの分析
Cigar_did_data_cluster <- Cigar_did_data %>%
miceadds::lm.cluster(data = .,
sales ~ ca + state + post + ca:post + year_dummy,
cluster = "state") %>%
summary()
# tidyverseとbroomの読み込み
library("tidyverse")
## 州ごとのデータでの分析
Cigar_did_data_cluster <- Cigar_did_data %>%
miceadds::lm.cluster(data = .,
sales ~ ca + state + post + ca:post + year_dummy,
cluster = "state") %>%
summary()
# (10) 州ごとのデータでの分析
## miceaddsのインストール
install.packages("miceadds")
install.packages("miceadds")
knitr::opts_chunk$set(echo = TRUE)
## 州ごとのデータでの分析
Cigar_did_data_cluster <- Cigar_did_data %>%
miceadds::lm.cluster(data = .,
sales ~ ca + state + post + ca:post + year_dummy,
cluster = "state") %>%
summary()
# (6) ライブラリの読み込み
library("Ecdat")
library(miceadds)
## 州ごとのデータでの分析
Cigar_did_data_cluster <- Cigar_did_data %>%
miceadds::lm.cluster(data = .,
sales ~ ca + state + post + ca:post + year_dummy,
cluster = "state") %>%
summary()
## 州ごとのデータでの分析
Cigar_did_data_cluster <- Cigar_did_data %>%
lm.cluster(data = .,
sales ~ ca + state + post + ca:post + year_dummy,
cluster = "state") %>%
summary()
## 州ごとのデータでの分析
Cigar_did_data_cluster <- Cigar_did_data %>%
lm.cluster(data = .,
sales ~ ca + state + post + ca:post + year_dummy,
cluster = "state") %>% summary()
knitr::opts_chunk$set(echo = TRUE)
install.packages("rdd")
## ライブラリの読み込み
library("rdd")
## non-parametric RDDの実行
rdd_result <- RDestimate(data = rdd_data,
formula = visit ~ history_log,
cutpoint = 5.5)
## ライブラリの読み込み
#install.packages("rdd")
library("rdd")
## non-parametric RDDの実行
rdd_result <- RDestimate(data = rdd_data,
formula = visit ~ history_log,
cutpoint = 5.5)
knitr::opts_chunk$set(echo = TRUE)
# 文字化け対応
par(family= "HiraKakuProN-W3")
library(ggplot2)
theme_set(theme_bw(base_family = "HiraKakuProN-W3"))
theme_gray(base_family ="HiraKakuPro-W3")
# ライブラリの読み出し
library("tidyverse")
library("broom")
# データの読み込み
email_data <- read_csv("http://www.minethatdata.com/Kevin_Hillstrom_MineThatData_E-MailAnalytics_DataMiningChallenge_2008.03.20.csv")
# ルールによるメールの配信を行ったログを作成
## データの整形とrunning variableの追加
male_data <- email_data %>%
filter(segment %in% c("Mens E-Mail","No E-Mail")) %>%
mutate(treatment = ifelse(segment == "Mens E-Mail", 1, 0),
history_log = log(history))
## cut-off の値を指定
threshold_value <- 5.5
## ルールによる介入を再現したデータを作成
## cut-offよりrunning variableが大きければ配信されたデータのみ残す
## 逆の場合には配信されなかったデータのみ残す
## running variableを0.1単位で区切ったグループわけの変数も追加しておく
rdd_data <- male_data %>%
mutate(history_log_grp = round(history_log/0.1,digits = 0)*0.1) %>%
filter(((history_log > threshold_value) &
(segment == "Mens E-Mail")) |
(history_log <= threshold_value) &
(segment == "No E-Mail"))
# running variableとサイト来訪率のプロット(RCTデータ)
male_data %>%
mutate(history_log_grp = round(history_log/0.1,digits = 0)*0.1) %>%
group_by(history_log_grp, segment) %>%
summarise(visit = mean(visit),
N = n()) %>%
filter(N > 10) %>%
ggplot(aes(y = visit,
x = history_log_grp,
shape = segment,
size = N)) +
geom_point() +
ylim(0,NA) +
theme_bw() +
xlab("log(history)") +
theme(plot.title = element_text(hjust = 0.5),
legend.position = "bottom",
plot.margin = margin(1,2,1,1, "cm"))
# running variableとサイト来訪率のプロット(RDDデータ)
## log(history)が5.5以上の場合のみメールを受け取ることになるため、log(history)が5.5以上でメールの介入が行われていないデータ ＆ log(history)が5.5以下でメールの介入が行われているデータを削除
rdd_data %>%
group_by(history_log_grp, segment) %>%
summarise(visit = mean(visit),
N = n()) %>%
filter(N > 10) %>%
ggplot(aes(y = visit,
x = history_log_grp,
shape = segment,
size = N)) +
geom_point() +
geom_vline(xintercept = 5.5, linetype = 2) +
ylim(0,NA) +
theme_bw() +
xlab("log(history)") +
theme(plot.title = element_text(hjust = 0.5),
legend.position = "bottom",
plot.margin = margin(1,2,1,1, "cm"))
# RCTデータでの比較
rct_data_table <- male_data %>%
filter(history_log > 5, history_log < 6) %>%
group_by(treatment) %>%
summarise(count = n(),
visit = mean(visit))
# RDDデータでの比較（RCTの効果から少し乖離してしまっている）
rdd_data_table <- rdd_data %>%
group_by(treatment) %>%
summarise(count = n(),
visit_rate = mean(visit))
# 線形回帰による分析（RDDとしてデータを削除したことで線形の関係にできたから効果がRCTの時と近くなっている）
rdd_lm_reg <- rdd_data %>%
mutate(treatment = ifelse(segment == "Mens E-Mail", 1, 0)) %>%
lm(data = ., formula = visit ~ treatment + history_log) %>%
summary() %>%
tidy() %>%
filter(term == "treatment")
# 非線形回帰による分析
#install.packages('remotes')
#remotes::install_github("bquast/rddtools")
library("rddtools")
nonlinear_rdd_data <- rdd_data(y = rdd_data$visit,
x = rdd_data$history_log,
cutpoint = 5.5)
nonlinear_rdd_ord4 <- rdd_reg_lm(rdd_object=nonlinear_rdd_data, order=4)
nonlinear_rdd_ord4
plot(nonlinear_rdd_ord4)
# 分析に使うデータの幅と分析結果のプロット
bound_list <- 2:100/100
result_data <- data.frame()
for(bound in bound_list){
out_data <- rdd_data %>%
filter(between(history_log, 5.5 - bound, 5.5 + bound)) %>%
group_by(treatment) %>%
summarise(count = n(),
visit_rate = mean(visit),
sd = sd(visit))
late <- out_data$visit_rate[2] - out_data$visit_rate[1]
N <- sum(out_data$count)
se <- sqrt(sum(out_data$visit_rate^2))/sqrt(N)
result_data <- rbind(result_data, data.frame(late, bound, N, se))
}
result_data %>%
ggplot(aes(y = late,
x = bound)) +
geom_ribbon(aes(ymax = late + 1.96*se,
ymin = late - 1.96*se), fill = "grey70") +
geom_line() +
theme_bw()
# nonparametric RDD
## ライブラリの読み込み
#install.packages("rdd")
library("rdd")
## non-parametric RDDの実行
rdd_result <- RDestimate(data = rdd_data,
formula = visit ~ history_log,
cutpoint = 5.5)
## 結果のレポート
summary(rdd_result)
## 結果のプロット
plot(rdd_result)
## manipulat
DCdensity(runvar = rdd_data %>% pull(history_log),
cutpoint = 5.5,
plot = FALSE)
## 結果のレポート
summary(rdd_result)
# 文字化け対応
par(family= "HiraKakuProN-W3")
library(ggplot2)
theme_set(theme_bw(base_family = "HiraKakuProN-W3"))
theme_gray(base_family ="HiraKakuPro-W3")
# パッケージのインストール
install.packages("dplyr")
install.packages("dplyr")
install.packages("tidyr")
library("tidyverse")
library("dplyr")
df1 <- read.csv("ID_POSデータ(POSデータ).csv")
df2 <- read.csv("ID_POSデータ(IDデータ).csv")
setwd("~/Documents/マーケティング統計")
df1 <- read.csv("ID_POSデータ(POSデータ).csv")
df2 <- read.csv("ID_POSデータ(IDデータ).csv")
table_df2 <- count(df2, 年代)
table_df2
table_df2 <- count(df2, 年代) %>%
spread()
table_df2 <- t(count(df2, 年代))
table_df2
table_df2 <- (count(df2, 年代))
table_df2
df2
table_df2 <- t(count(df2, 年代))
table_df2
table_df2 <- t(count(df2, 年代), header = T)
table_df2 <- as.data.frame(t(count(df2, 年代)))
table_df2
class(table_df2)
table_df2 <- t(count(df2, 年代))
class(table_df2)
table_df2 <- as.data.frame(t(count(df2, 年代)))
class(table_df2)
names <- c(1,2,3,4,5,6,7,8,9,10)
table_df2 <- t(count(df2, 年代))
names(table_df2) <- names
table_df2
mynames <- c(1,2,3,4,5,6,7,8,9,10)
names(table_df2) <- mynames
table_df2
colnames(table_df2) <- c(1,2,3,4,5,6,7,8,9,10)
table_df2
colnames(table_df2) <- c("1,2,3,4,5,6,7,8,9,10")
colnames(table_df2) <- c("1","2","3","4","5","6","7","8","9","10")
table_df2
df2 <- read.csv("ID_POSデータ(IDデータ).csv")
table_df2 <- as.data.frame(t(count(df2, 年代)))
class(table_df2)
colnames(table_df2) <- c(1,2,3,4,5,6,7,8,9,10)
table_df2
# ID_POSデータ
df1 <- read.csv("ID_POSデータ(POSデータ).csv")
df1
df2
