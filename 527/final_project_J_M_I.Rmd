---
title: Final Project 527"
author: "Satoshi Ido, Shu-Ming Meng, Robert Jung"
date: 17 April 2023
output: pdf_document
---
```{r setup, include = FALSE, cache = FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    warning = FALSE,
    message = FALSE)
```


# library
```{r}
library("MASS")
library("lmtest")
library("stringr")
library("dplyr")
library("data.table")
library("stringi")
library("openxlsx")
library("ggplot2")
library("lattice")
library("epiDisplay")
library("car")
library("treemap")
library("d3treeR")
library("htmlwidgets")
```

# import the dataset
```{r}
print(getwd())
df <- read.csv("/Users/satoshiido/Documents/statistical-analysis/527/unicorn_data.csv")
head(df, 3)
```

# preprocess
clean the data
```{r}
billion_func <- function(y){
    # if the value in the column include "B", extract them
    tmp <- y %>% filter(str_detect(y[, "Total.Raised.Million"], "B"))
    # remove the $ and B signs
    tmp$Total.Raised.Million <- stri_replace_all_regex(
            tmp$Total.Raised.Million, pattern = c("[$]", "[B]"),
            replacement = c("", ""),
            vectorize = FALSE
            )
    # change the data type to numeric
    tmp <- tmp %>% mutate_at("Total.Raised.Million", as.numeric)
    # unit convert from $B to $M
    tmp[, "Total.Raised.Million"] <- tmp[, "Total.Raised.Million"] * 1000

    return(tmp)
    }

million_func <- function(y){
    # if the value in the column include "M", extract them
    tmp <- y %>% filter(str_detect(y[, "Total.Raised.Million"], "M"))
    # remove the $ and M signs
    tmp$Total.Raised.Million <- stri_replace_all_regex(
            tmp$Total.Raised.Million, pattern = c("[$]", "[M]"),
            replacement = c("", ""),
            vectorize = FALSE
            )
    # change the data type to numeric
    tmp <- tmp %>% mutate_at("Total.Raised.Million", as.numeric)
    return(tmp)
    }


cleaner <- function(x){
    # delete the unncessary columns
    x <- subset(
        x,
        select = -c(
            Investors, Portfolio.Exits, Entrepreneur,
            Final.Degree, Final.School)
        )
    # divide into two dataset and convert
    tmp0 <- billion_func(x)
    tmp1 <- million_func(x)
    x <- rbind(tmp0, tmp1)

    # remove the $ and convert character into numeric
    x$Valuation.Billion <- stri_replace_all_regex(
            x$Valuation.Billion, pattern = "[$]",
            replacement = "",
            vectorize = FALSE
            )
    x <- x %>% mutate_at("Valuation.Billion", as.numeric)

    # create the another column with unit of "M"
    x[, "Valuation.Million"] <- x[, "Valuation.Billion"] * 1000

    # change string to date format
    x$Date.Joined <- as.Date(x$Date.Joined, format = "%m/%d/%Y")
    # return the list of Investors given delimited strings
    x$Select.Investors <- strsplit(x$Select.Investors, split = ", ")

    # calculate how many months pasted since each company has joined the unicorn
    floor_dec <- function(y, level=1) {round(y - 5 * 10^(-level - 1), level)}
    YearMonth <- 
        (20231200 - round(as.numeric(gsub("-", "", x$Date.Joined)), -2)) / 100
        for (i in 1 : length(x$Founded.Year)) {
            if ((YearMonth[i] %% 100 - 8) < 0) {
                x$Date.Joined_in_months[i] <- (
                    floor_dec(YearMonth[i]/100,0)-1)*12+abs(YearMonth[i]%%100-4
                )
            }
            else {
                x$Date.Joined_in_months[i] <- (
                    floor_dec(YearMonth[i]/100,0))*12+abs(YearMonth[i]%%100-4
                )
            }
        }
    return(x)
    }

df <- cleaner(df)
```

# Visualization
## Tree Map by Country and Industry
```{r}
# basic treemap
treemap(df,
            index = c("Country", "Industry", "Company"),
            type = "index",
            vSize = "Valuation.Billion",
            fontcolor.labels = c("white", "white"),
            fontsize.title = 14,
            fontsize.labels = c(12, 9, 8),
            palette = "Set2",
            bg.labels = c("transparent"),
            align.labels = list(
              c("left", "top"),
              c("right", "bottom"),
              c("center", "center")
            ),
            border.col = c("black", "black", "black"),
            border.lwds = c(4, 2, 1),
            title = "Valuation by Country&Industry",
            overlap.labels = 0,
            inflate.labels = F
        )
```
We can see some countries (US, China mainly) are the major countries producting unicorn companies.
It is noticeable that there are some popular industries (such as Fintech, IT, AI, E-commerce) and some countries have advantage in specific industries 
For example, UK has many unicorn companies in Fintech industry while AI and E-commerce are popular indsutries in China.
From this plot, we decided to mainly look into Country, City, and Industry.

## Top 5 Countries
```{r}
# group by country and count the number of each country
tmp <- df %>%
    group_by(Country) %>%
    summarise(total.country.count = n(), .groups = "drop")
# pick the top 5 countries which produce the unicorn the most
top5countries <- unlist(tmp[order(tmp$total.country.count, decreasing = TRUE), ][0:5, 1])
tmp <- df[which(df$Country %in% top5countries), ] %>%
    group_by(Country) %>%
    summarise(total.value.Billion = sum(Valuation.Billion), .groups = "drop") %>%
    as.data.frame()

# plot
ggplot(
        tmp,
        aes(x = reorder(Country, -total.value.Billion),
        y = total.value.Billion)) +
    geom_bar(stat = "identity", fill = "skyblue4") +
    labs(
        title = "Top 5 countries producing unicorn companies values",
        x = "Country",
        y = "Total.value(B)") +
    theme(
        plot.title = element_text(size = 12, hjust = 0.5, color = "gray25"),
        axis.title.x = element_text(size = 10, hjust = 0.5, color = "gray25"),
        axis.title.y = element_text(size = 10, hjust = 0.5, color = "gray25")
        )

```
Top countries producing the unicorn companies most are US, China, India, UK, and Germany. US and China are leading unicorn booms.

## Top 10 Cities
```{r}
# group by city and count the number of each city
tmp <- df %>%
    group_by(City) %>%
    summarise(total.city.count = n(), .groups = "drop")
# pick the top 10 cities which produce the unicorn the most
top10cities <- unlist(tmp[order(tmp$total.city.count, decreasing = TRUE), ][0:10, 1])
tmp <- df[which(df$City %in% top10cities), ] %>%
    group_by(City) %>%
    summarise(total.value.Billion = sum(Valuation.Billion), .groups = "drop") %>%
    as.data.frame()

# plot
ggplot(
        tmp,
        aes(x = reorder(City, -total.value.Billion),
        y = total.value.Billion)) +
    geom_bar(stat = "identity", fill = "skyblue4") +
    labs(
        title = "Top 10 cities producing unicorn companies values",
        x = "City",
        y = "Total.value(B)") +
    theme(
        plot.title = element_text(size = 12, hjust = 0.5, color = "gray25"),
        axis.title.x = element_text(size = 10, hjust = 0.5, color = "gray25"),
        axis.title.y = element_text(size = 10, hjust = 0.5, color = "gray25"),
        axis.text.x = element_text(size = 8, angle = 60, vjust = 0.7, hjust = 0.7)
        )
```
Top cities producing many unicorn companies are SF, Beijing, NY, London, Shanghai, Bengaluru, Shenzhen, and so on. 
Mostly, the major metropolitan areas in US, China, and India

## Founded Year
```{r}
# barchart
barplot(table(df$Founded.Year))
```
As we expected, the majority of unicorn companies are founded in 2010's. 
It is obvious that it is a recent trend among startups for not doing IPO.

## Number of Unicorn Companies by Each Industry
```{r}
# frequency barchart
tab1(df$Industry, main = "Unicorn Companies by Industry", cum.percent = TRUE)
```
We can clearly see the Fintech and Internet software & services are the two most dominating Industries in this case with 208 and 189 companies respectively.

## Legacy or Growing Industries vs Companies Valuation
Preprocess
```{r}
# divide into subgroup
# Growing IND
growing_list <- c("Artificial Intelligence", "Cybersecurity",
        "Data management & analytics", "Edtech", "Fintech",
        "E-commerce & direct-to-consumer"
        )
df_GI <- df[which(df$Industry %in% growing_list), ]

# Legacy IND
legacy_list <- c("Auto & transportation","Consumer & retail","Hardware",
            "Health","Supply chain, logistics, & delivery","Travel",
            "Internet software & services","Mobile & telecommunications"
            )
df_LI <- df[which(df$Industry %in% legacy_list), ]
```

## Legacy or Growing Industries vs Companies Valuation
```{r}
# plotting
ggplot(df_LI, aes(x=Industry, y=Valuation.Billion, fill=Industry)) +
    geom_boxplot()+
    theme(axis.text.x = element_text(size = 8, angle = 60, vjust = 0.7, hjust = 0.7)) +
    labs(
        title = "Legacy Industries' Valuation",
        x = "Industry",
        y = "Valuation.Billion")
```
```{r}
ggplot(df_GI, aes(x=Industry, y=Valuation.Billion, fill=Industry)) +
    geom_boxplot()+
    theme(axis.text.x = element_text(size = 8, angle = 60, vjust = 0.7, hjust = 0.7)) +
    labs(
        title = "Growing Industries' Valuation",
        x = "Industry",
        y = "Valuation.Billion")
```
There are apparently a lot of outliers in  both legacy and growing industries, but the scale of growing industries is larger. 
That could mean even with similar median company valuation, more companies from growing industries have way higher company valuation.


## Time of Each Industry Taking to Become Unicorn Comapnies
```{r}
ggplot(df, aes(x=Industry, y=Date.Joined_in_months, fill=Industry)) +
    geom_boxplot()+
    theme(
        axis.text.x = element_text(size = 8, angle = 60, vjust = 0.7, hjust = 0.7)) +
    labs(
    title = "Time taken to be Unicorn",
    x = "Industry",
    y = "Months Taken to Join")

```
We roughly calculated how many months each company took to become unicorn company and group them by Industry. 
Clearly, there's difference between some these industries.

# Deal.Term vs Country by Industry
```{r}
ggplot(
    data = df_GI,
    aes(x = Country, y = Deal.Terms, fill = Industry)) +
    geom_bar(position = "stack", stat="identity") +
    theme(axis.text.x = element_text(size = 7, angle = 60, vjust = 0.7, hjust = 0.7)
    )
```
```{r}
ggplot(
    data = df_LI,
    aes(x = Country, y = Deal.Terms, fill = Industry)) +
    geom_bar(position = "stack", stat = "identity") +
    theme(axis.text.x = element_text(size = 7, angle = 60, vjust = 0.7, hjust = 0.7)
    )
```

# Investors
```{r}
# count the number of unicorn startups each investor has invested
# create the matrix of investors frequency count
words.freq <- table(unlist(df$Select.Investors))
investors <- cbind(names(words.freq), as.integer(words.freq))
investors <- as.data.frame(investors)
investors$V2 <- as.numeric(investors$V2)
colnames(investors) <- c("investors", "count")
investors <- investors[order(investors$count, decreasing = TRUE), ]
top_investors <- filter(investors, count > 20)


options(repr.plot.width = 15, repr.plot.height = 8)
top_investors <- filter(investors, count > 20)
ggplot(data = top_investors, aes(x = reorder(investors, -count), y = count)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 75, vjust = 1, hjust = 1))
```
As we rank the investors based on how many unicorn companies each of them has invested, we notice that there are some succesful investors who invested more than 20 startups which ended up becoming unicorn companies. 
We picked those successful investors and did plot them


# Modeling
## Data Preprocess
```{r}
# Country
## group by country and count the number of each country
tmp <- df %>%
    group_by(Country) %>%
    summarise(total.country.count = n(), .groups = "drop")
topcountries.list <- unlist(tmp[tmp$total.country.count > 5, ][, 1])

# city
## group by city and count the number of each city
tmp <- df %>%
    group_by(City) %>%
    summarise(total.city.count = n(), .groups = "drop")
topcities.list <- unlist(tmp[tmp$total.city.count > 10, ][, 1])


# Country.label & City.label
# Add a columns to Dataframe regarding to top countries and top cities
df2 <- df %>%
        mutate(Country.label = ifelse(
                Country %in% topcountries.list, 1, 0)) %>%
        mutate(City.label = ifelse(
                City %in% topcities.list, 1, 0))

# replace the county names if they produce less than or equal to 5 companies
df2$Country[df2$Country.label == 0] <- "others"
# replace the city names if they produce less than or equal to 10 companies
df2$City[df2$City.label == 0] <- "others"

# Investor.label
words.freq <- table(unlist(df2$Select.Investors))
investors <- cbind(names(words.freq), as.integer(words.freq))
investors <- as.data.frame(investors)
investors$V2 <- as.numeric(investors$V2)
colnames(investors) <- c("investors", "count")
investors <- investors[order(investors$count, decreasing = TRUE), ]
top_investors <- filter(investors, count > 20)
## x = df2
investor.fun <- function(x) {
    y <- x$Select.Investors
    for (i in 1:length(y)) {
        for (k in 1:length(y[[i]])) {
            # if "k"th investor in "i"th list in 
            # dataframe is in top_investors$investors,
            ifelse(
                y[[i]][k] %in% top_investors$investors,
                # And if "i"th value in "Investor.label"
                # column is blank, simply insert "1",
                ifelse(
                    is.null(x$Investor.label[i]),
                    x$Investor.label[i] <- 1,
                    # if "i"th value in "Investor.label" column = "1",
                    # keep it, if = "0", replace it with "1"
                    ifelse(
                        x$Investor.label[i] == 1,
                        x$Investor.label[i],
                        x$Investor.label[i] <- 1)
                    # if "k"th investor in "i"th list in dataframe is
                    # not in top_investors$investors, insert "0"
                ), x$Investor.label[i] <- 0
            )
        }
    }
    return(x)
}
df2 <- investor.fun(df2)
df2$Investor.label <- as.character(df2$Investor.label)
```

# Modeling
```{r}
lm <- lm(data = df2,
        Valuation.Billion ~ Country + City + Industry
        + Founded.Year + Total.Raised.Million + Investors.Count
        + Deal.Terms + Date.Joined_in_months + Investor.label)
summary(lm)
summary(stepAIC(lm))
```
Before we conclude the output, we have to be careful about the limitation of linear model. 
Applying a Linear model to these compled data is not the optimal method since it does not take in account its collinearity and the risk of incorporating categorical values.
